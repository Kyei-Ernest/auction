<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Auction Dashboard with Phone and Pagination</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:0;
    display: flex;
    height: 100vh;
    background: #f5f7fa;
    flex-direction: column;
  }
  header {
    background: #2f3e4d;
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  header label {
    font-weight: bold;
  }
  header select, header input[type="text"] {
    padding: 5px;
    font-size: 1rem;
  }
  header button {
    padding: 6px 12px;
    font-size: 1rem;
    cursor: pointer;
  }
  main {
    flex-grow: 1;
    display: flex;
    overflow: hidden;
  }
  aside {
    width: 270px;
    background: #2f3e4d;
    color: white;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  aside h2 {
    font-size: 1.3rem;
    margin-top: 0;
    border-bottom: 1px solid #556677;
    padding-bottom: 6px;
  }
  section {
    flex-grow: 1;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  .online-count {
    margin-bottom: 15px;
    font-weight: bold;
  }
  .user-list {
    margin-bottom: 20px;
  }
  .user-list ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  .user-list li {
    padding: 6px 8px;
    background: #3b4b5a;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 0.9rem;
  }
  .user-list li.seller {
    background: #2a8fbd;
  }
  .user-list li.buyer {
    background: #7bc67e;
  }
  h1 {
    margin-top: 0;
    margin-bottom: 15px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 10px 12px;
    border-bottom: 1px solid #ddd;
    text-align: left;
    font-size: 0.9rem;
    vertical-align: middle;
  }
  th {
    background: #3b4b5a;
    color: white;
  }
  tbody tr:hover {
    background: #f0f8ff;
  }
  .status-open {
    color: green;
    font-weight: bold;
  }
  .status-closed {
    color: red;
    font-weight: bold;
  }
  .bid-amount {
    font-weight: bold;
    color: #2a8fbd;
  }
  .highlight {
    background: #ffffcc;
  }
  button.select-winner-btn, button.select-winner-modal-btn {
    padding: 6px 12px;
    font-size: 0.9rem;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    background-color: #2a8fbd;
    color: white;
  }
  button.select-winner-btn:hover, button.select-winner-modal-btn:hover {
    background-color: #1f6fa3;
  }
  #bidSection, #newProductSection {
    margin-top: 20px;
    background: white;
    padding: 15px;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
    border-radius: 6px;
    max-width: 480px;
  }
  #bidSection label, #newProductSection label {
    display: block;
    margin: 8px 0 4px;
    font-weight: bold;
  }
  #bidSection input[type="number"], #bidSection select,
  #newProductSection input[type="text"], #newProductSection input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    font-size: 1rem;
    box-sizing: border-box;
  }
  #bidSection button, #newProductSection button {
    margin-top: 12px;
    padding: 8px 15px;
    font-size: 1rem;
    cursor: pointer;
  }
  #bidInfo, #productInfo {
    margin-top: 10px;
    font-style: italic;
    color: #555;
  }
  #charts {
    display: flex;
    gap: 30px;
    margin-top: 30px;
    flex-wrap: wrap;
  }
  .chart-container {
    background: white;
    padding: 15px;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
    border-radius: 6px;
    flex: 1 1 300px;
    min-width: 300px;
  }
  .chart-container h3 {
    margin-top: 0;
    margin-bottom: 10px;
  }
  /* Modal styles */
  #winnerModal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100vw;
    height:100vh;
    background: rgba(0,0,0,0.5);
    justify-content:center;
    align-items:center;
    z-index:1000;
  }
  #winnerModal > div {
    background:#fff;
    border-radius:8px;
    width:90%;
    max-width:600px;
    max-height:80vh;
    overflow-y:auto;
    padding:20px;
    position:relative;
  }
  #winnerModal table {
    width: 100%;
    border-collapse: collapse;
  }
  #winnerModal th, #winnerModal td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: left;
  }
  #winnerModal th {
    background: #3b4b5a;
    color: white;
  }
  #closeModalBtn {
    margin-top: 15px;
    padding: 8px 15px;
    font-size: 1rem;
    cursor: pointer;
  }
  /* Pagination buttons */
  #paginationControls {
    margin-top: 10px;
    display: flex;
    gap: 10px;
  }
  #paginationControls button {
    padding: 6px 12px;
    font-size: 0.9rem;
    cursor: pointer;
    border-radius: 4px;
    border: 1px solid #2a8fbd;
    background-color: white;
    color: #2a8fbd;
  }
  #paginationControls button:disabled {
    opacity: 0.5;
    cursor: default;
  }
</style>
</head>
<body>

<header>
  <label for="roleSelect">Login as:</label>
  <select id="roleSelect" aria-label="Select user role">
    <option value="" selected disabled>-- Choose Role --</option>
    <option value="buyer">Buyer</option>
    <option value="seller">Seller</option>
  </select>

  <label for="userSelect" id="userSelectLabel" style="display:none;">Select User:</label>
  <select id="userSelect" aria-label="Select user name" style="display:none;"></select>

  <button id="loginBtn" disabled>Login</button>

  <div id="loggedInUser" style="margin-left:auto; font-weight:bold; color:#fff;"></div>
</header>

<main>
  <aside>
    <h2>Online Users</h2>
    <div class="online-count" id="onlineCount">Users Online: 0</div>

    <div class="user-list" id="sellerList">
      <h3>Sellers</h3>
      <ul></ul>
    </div>

    <div class="user-list" id="buyerList">
      <h3>Buyers</h3>
      <ul></ul>
    </div>
  </aside>

  <section>
    <h1>Active Auctions & Bids</h1>
    <table id="auctionsTable" aria-label="Active auctions and bids">
      <thead>
        <tr>
          <th>Product</th>
          <th>Seller</th>
          <th>Seller Phone</th>
          <th>Status</th>
          <th>Min Bid (GHS)</th>
          <th>Highest Bid (GHS)</th>
          <th>Highest Bidder</th>
          <th>Bidder Phone</th>
          <th>Bids Count</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filled by JS -->
      </tbody>
    </table>

    <div id="paginationControls" aria-label="Pagination controls">
      <button id="prevPageBtn" disabled>Previous</button>
      <span id="pageInfo" style="align-self:center;">Page 1</span>
      <button id="nextPageBtn" disabled>Next</button>
    </div>

    <div id="bidSection" style="display:none;">
      <h2>Place a Bid</h2>
      <label for="auctionSelect">Select Auction:</label>
      <select id="auctionSelect" aria-label="Select auction to bid on"></select>

      <label for="bidAmountInput">Bid Amount (GHS):</label>
      <input type="number" id="bidAmountInput" min="1" step="1" />

      <button id="placeBidBtn">Place Bid</button>
      <div id="bidInfo"></div>
    </div>

    <div id="newProductSection" style="display:none;">
      <h2>Create New Product</h2>
      <label for="newProductName">Product Name:</label>
      <input type="text" id="newProductName" placeholder="e.g. Samsung Galaxy S22" />

      <label for="newProductMinBid">Minimum Bid Amount (GHS):</label>
      <input type="number" id="newProductMinBid" min="1" step="1" placeholder="e.g. 1000" />

      <button id="createProductBtn">Add Product</button>
      <div id="productInfo"></div>
    </div>

    <div id="charts">
      <div class="chart-container">
        <h3>Bids per Auction</h3>
        <canvas id="bidsBarChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Auction Status Distribution</h3>
        <canvas id="statusPieChart"></canvas>
      </div>
    </div>

  </section>
</main>

<!-- Winning Bid Selection Modal -->
<div id="winnerModal" role="dialog" aria-modal="true" aria-labelledby="winnerModalTitle">
  <div>
    <h2 id="winnerModalTitle">Select Winning Bid</h2>
    <table id="modalBidsTable" aria-label="List of bids for selection">
      <thead>
        <tr>
          <th>Bidder</th>
          <th>Bid Amount (GHS)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filled dynamically -->
      </tbody>
    </table>
    <button id="closeModalBtn">Close</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const sellers = [
    { id: 1, name: 'Ama Boateng', phone: '0244123456' },
    { id: 2, name: 'Kwame Mensah', phone: '0277987654' },
    { id: 3, name: 'Nana Owusu', phone: '0201234567' }
  ];

  const buyers = [
    { id: 11, name: 'Yaa Asantewaa', phone: '0551234567' },
    { id: 12, name: 'Kofi Antwi', phone: '0507654321' },
    { id: 13, name: 'Efua Sarpong', phone: '0549876543' },
    { id: 14, name: 'Kojo Frimpong', phone: '0263344556' },
    { id: 15, name: 'Akosua Nyarko', phone: '0244556677' }
  ];

  let auctions = [
    {
      id: 101,
      product: 'iPhone 14 Pro Max',
      sellerId: 1,
      status: 'open',
      minBid: 4000,
      winningBid: null,
      bids: [
        { bidderId: 11, bidderName: 'Yaa Asantewaa', amount: 5000 },
        { bidderId: 14, bidderName: 'Kojo Frimpong', amount: 5200 },
        { bidderId: 12, bidderName: 'Kofi Antwi', amount: 5300 }
      ]
    },
    {
      id: 102,
      product: 'Dell XPS 13 Laptop',
      sellerId: 2,
      status: 'open',
      minBid: 3000,
      winningBid: null,
      bids: [
        { bidderId: 13, bidderName: 'Efua Sarpong', amount: 3500 },
        { bidderId: 15, bidderName: 'Akosua Nyarko', amount: 3600 }
      ]
    },
    {
      id: 103,
      product: 'Samsung Galaxy Buds',
      sellerId: 3,
      status: 'closed',
      minBid: 300,
      winningBid: { bidderId: 14, bidderName: 'Kojo Frimpong', amount: 450 },
      bids: [
        { bidderId: 11, bidderName: 'Yaa Asantewaa', amount: 400 },
        { bidderId: 14, bidderName: 'Kojo Frimpong', amount: 450 }
      ]
    }
  ];

  let currentUser = null;

  let bidsBarChartInstance = null;
  let statusPieChartInstance = null;

  // Pagination
  const ITEMS_PER_PAGE = 10;
  let currentPage = 1;
  let filteredAuctionsForPage = [];

  const roleSelect = document.getElementById('roleSelect');
  const userSelect = document.getElementById('userSelect');
  const userSelectLabel = document.getElementById('userSelectLabel');
  const loginBtn = document.getElementById('loginBtn');
  const loggedInUserDiv = document.getElementById('loggedInUser');
  const bidSection = document.getElementById('bidSection');
  const auctionSelect = document.getElementById('auctionSelect');
  const bidAmountInput = document.getElementById('bidAmountInput');
  const placeBidBtn = document.getElementById('placeBidBtn');
  const newProductSection = document.getElementById('newProductSection');
  const newProductNameInput = document.getElementById('newProductName');
  const newProductMinBidInput = document.getElementById('newProductMinBid');
  const createProductBtn = document.getElementById('createProductBtn');
  const productInfo = document.getElementById('productInfo');
  const bidInfo = document.getElementById('bidInfo');

  // Modal Elements
  const winnerModal = document.getElementById('winnerModal');
  const modalBidsTableBody = document.querySelector('#modalBidsTable tbody');
  const closeModalBtn = document.getElementById('closeModalBtn');

  // Pagination controls
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const pageInfo = document.getElementById('pageInfo');

  let currentAuctionForModal = null;

  // Prompt user phone after user select
  userSelect.addEventListener('change', () => {
    // Reset login button disable state, phone will be prompted at login time now
    loginBtn.disabled = false;
  });

  roleSelect.addEventListener('change', () => {
    const role = roleSelect.value;
    if (!role) {
      userSelect.style.display = 'none';
      userSelectLabel.style.display = 'none';
      loginBtn.disabled = true;
      return;
    }
    userSelect.style.display = 'inline-block';
    userSelectLabel.style.display = 'inline-block';

    let users = role === 'seller' ? sellers : buyers;
    userSelect.innerHTML = '';
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = u.name;
      userSelect.appendChild(opt);
    });
    loginBtn.disabled = true;
  });

  loginBtn.addEventListener('click', () => {
    const role = roleSelect.value;
    if (!role) return alert('Select a role');

    const userId = parseInt(userSelect.value);
    if (!userId) return alert('Select a user');

    // Get user object from sellers or buyers array
    let user;
    if (role === 'seller') {
      user = sellers.find(u => u.id === userId);
    } else {
      user = buyers.find(u => u.id === userId);
    }
    if (!user) return alert('User not found');

    // Prompt for phone number and validate
    const inputPhone = prompt(`Enter phone number for ${user.name}:`, user.phone || '');
    if (!inputPhone || inputPhone.trim().length < 5) {
      alert('Phone number is required and must be at least 5 characters.');
      return;
    }
    user.phone = inputPhone.trim();

    currentUser = {...user, role};
    loggedInUserDiv.textContent = `Logged in as ${currentUser.role.toUpperCase()}: ${currentUser.name} (${currentUser.phone})`;

    // Reset UI
    currentPage = 1;
    renderDashboard();
  });

  // Render lists of online users
  function renderUserLists() {
    const sellerListUL = document.querySelector('#sellerList ul');
    const buyerListUL = document.querySelector('#buyerList ul');

    sellerListUL.innerHTML = '';
    buyerListUL.innerHTML = '';

    sellers.forEach(s => {
      const li = document.createElement('li');
      li.textContent = `${s.name} (${s.phone || 'No phone'})`;
      li.className = 'seller';
      sellerListUL.appendChild(li);
    });
    buyers.forEach(b => {
      const li = document.createElement('li');
      li.textContent = `${b.name} (${b.phone || 'No phone'})`;
      li.className = 'buyer';
      buyerListUL.appendChild(li);
    });

    const totalOnline = sellers.length + buyers.length;
    document.getElementById('onlineCount').textContent = `Users Online: ${totalOnline}`;
  }

  // Pagination Helpers
  function getFilteredAuctions() {
    if (!currentUser) return auctions;

    if (currentUser.role === 'seller') {
      return auctions.filter(a => a.sellerId === currentUser.id);
    }
    return auctions;
  }

  function getAuctionsPage(page) {
    const filtered = getFilteredAuctions();
    const startIdx = (page - 1) * ITEMS_PER_PAGE;
    return filtered.slice(startIdx, startIdx + ITEMS_PER_PAGE);
  }

  // Render auctions with pagination
  function renderAuctions() {
    const tbody = document.querySelector('#auctionsTable tbody');
    tbody.innerHTML = '';

    const filteredAuctions = getFilteredAuctions();
    filteredAuctionsForPage = getAuctionsPage(currentPage);

    // Update pagination buttons
    const totalPages = Math.ceil(filteredAuctions.length / ITEMS_PER_PAGE);
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;

    filteredAuctionsForPage.forEach(auction => {
      const tr = document.createElement('tr');

      // Find seller
      const seller = sellers.find(s => s.id === auction.sellerId);
      const sellerName = seller ? seller.name : 'Unknown';
      const sellerPhone = seller ? seller.phone || '-' : '-';

      // Highest bid info
      let highestBidAmount = 0;
      let highestBidderName = '-';
      let highestBidderPhone = '-';

      if (auction.bids.length > 0) {
        const highestBid = auction.bids.reduce((max, b) => b.amount > max.amount ? b : max, auction.bids[0]);
        highestBidAmount = highestBid.amount;
        highestBidderName = highestBid.bidderName;

        // Find phone for highest bidder
        const bidder = buyers.find(b => b.id === highestBid.bidderId) || sellers.find(s => s.id === highestBid.bidderId);
        highestBidderPhone = bidder ? (bidder.phone || '-') : '-';
      }

      const statusClass = auction.status === 'open' ? 'status-open' : 'status-closed';
      const statusText = auction.status.charAt(0).toUpperCase() + auction.status.slice(1);

      // Action content
      let actionContent = '-';
      if (currentUser && currentUser.role === 'seller' && currentUser.id === auction.sellerId) {
        if (auction.status === 'open' && auction.bids.length > 0) {
          actionContent = `<button class="select-winner-modal-btn" data-auctionid="${auction.id}">Select Winner</button>`;
        } else if (auction.status === 'closed' && auction.winningBid) {
          // Show winner + phone
          const winnerBidder = buyers.find(b => b.id === auction.winningBid.bidderId) || sellers.find(s => s.id === auction.winningBid.bidderId);
          const winnerPhone = winnerBidder ? (winnerBidder.phone || '-') : '-';
          actionContent = `<strong>Winner:</strong> ${auction.winningBid.bidderName}<br>
                           <strong>Amount:</strong> GHS ${auction.winningBid.amount}<br>
                           <strong>Buyer Phone:</strong> ${winnerPhone}`;
        } else if (auction.status === 'open') {
          actionContent = 'No bids yet';
        }
      } else if (auction.status === 'closed' && auction.winningBid) {
        // For buyers and others, show winner without phone
        actionContent = `<strong>Winner:</strong> ${auction.winningBid.bidderName}<br>
                         <strong>Amount:</strong> GHS ${auction.winningBid.amount}`;
      }

      tr.innerHTML = `
        <td>${auction.product}</td>
        <td>${sellerName}</td>
        <td>${sellerPhone}</td>
        <td class="${statusClass}">${statusText}</td>
        <td>GHS ${auction.minBid}</td>
        <td class="bid-amount">GHS ${highestBidAmount}</td>
        <td>${highestBidderName}</td>
        <td>${highestBidderPhone}</td>
        <td>${auction.bids.length}</td>
        <td>${actionContent}</td>
      `;
      tbody.appendChild(tr);
    });

    // Attach winner modal buttons events
    document.querySelectorAll('.select-winner-modal-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const auctionId = parseInt(btn.getAttribute('data-auctionid'));
        openWinnerModal(auctionId);
      });
    });
  }

  // Select winning bid
  function selectWinningBid(auctionId, bidIdx) {
    if (!currentUser || currentUser.role !== 'seller') {
      alert('Only sellers can select winning bids');
      return;
    }
    const auction = auctions.find(a => a.id === auctionId);
    if (!auction) return alert('Auction not found');
    if (auction.sellerId !== currentUser.id) {
      alert('You can only select winning bids for your own products');
      return;
    }
    if (auction.status !== 'open') {
      alert('Auction is already closed');
      return;
    }

    const winningBid = currentAuctionForModal.bids[bidIdx];
    if (!winningBid) return alert('Bid not found');

    auction.winningBid = winningBid;
    auction.status = 'closed';

    alert(`Winning bid selected:\n${winningBid.bidderName} with GHS ${winningBid.amount}`);

    closeWinnerModal();
    renderDashboard();
  }

  // Render auction select dropdown for buyers when placing bid
  function renderAuctionSelect() {
    auctionSelect.innerHTML = '';

    // Only open auctions for bidding
    const openAuctions = auctions.filter(a => a.status === 'open');

    openAuctions.forEach(a => {
      auctionSelect.appendChild(new Option(`${a.product} (Min Bid: GHS ${a.minBid})`, a.id));
    });

    if (openAuctions.length === 0) {
      auctionSelect.appendChild(new Option('No open auctions available', ''));
      auctionSelect.disabled = true;
      placeBidBtn.disabled = true;
    } else {
      auctionSelect.disabled = false;
      placeBidBtn.disabled = false;
    }
  }

  // Place bid event
  placeBidBtn.addEventListener('click', () => {
    bidInfo.textContent = '';
    if (!currentUser || currentUser.role !== 'buyer') {
      alert('Only buyers can place bids');
      return;
    }
    const auctionId = parseInt(auctionSelect.value);
    if (!auctionId) {
      alert('Select an auction to bid on');
      return;
    }
    const bidAmount = parseInt(bidAmountInput.value);
    if (!bidAmount || bidAmount <= 0) {
      alert('Enter a valid bid amount');
      return;
    }

    const auction = auctions.find(a => a.id === auctionId);
    if (!auction) {
      alert('Auction not found');
      return;
    }
    if (auction.status !== 'open') {
      alert('Auction is closed, cannot bid');
      return;
    }
    if (bidAmount < auction.minBid) {
      alert(`Bid must be at least the minimum bid: GHS ${auction.minBid}`);
      return;
    }
    // Check if bid is higher than existing highest bid
    const highestBidAmount = auction.bids.length > 0
      ? auction.bids.reduce((max, b) => b.amount > max ? b.amount : max, 0)
      : 0;
    if (bidAmount <= highestBidAmount) {
      alert(`Bid must be higher than current highest bid: GHS ${highestBidAmount}`);
      return;
    }

    auction.bids.push({
      bidderId: currentUser.id,
      bidderName: currentUser.name,
      amount: bidAmount
    });

    bidInfo.textContent = `Bid placed successfully: GHS ${bidAmount}`;
    bidAmountInput.value = '';

    renderDashboard();
  });

  // Create new product event (sellers only)
  createProductBtn.addEventListener('click', () => {
    productInfo.textContent = '';
    if (!currentUser || currentUser.role !== 'seller') {
      alert('Only sellers can create products');
      return;
    }
    const productName = newProductNameInput.value.trim();
    const minBid = parseInt(newProductMinBidInput.value);

    if (!productName) {
      alert('Enter a product name');
      return;
    }
    if (!minBid || minBid < 1) {
      alert('Enter a valid minimum bid amount (>=1)');
      return;
    }

    const newId = auctions.length > 0 ? Math.max(...auctions.map(a => a.id)) + 1 : 1;

    auctions.push({
      id: newId,
      product: productName,
      sellerId: currentUser.id,
      status: 'open',
      minBid: minBid,
      winningBid: null,
      bids: []
    });

    productInfo.textContent = `Product "${productName}" added with minimum bid GHS ${minBid}.`;
    newProductNameInput.value = '';
    newProductMinBidInput.value = '';

    renderDashboard();
  });

  // Charts rendering
  function renderCharts() {
    const ctxBar = document.getElementById('bidsBarChart').getContext('2d');
    const auctionLabels = auctions.map(a => a.product);
    const bidsCountData = auctions.map(a => a.bids.length);

    if (bidsBarChartInstance) bidsBarChartInstance.destroy();

    bidsBarChartInstance = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: auctionLabels,
        datasets: [{
          label: 'Number of Bids',
          data: bidsCountData,
          backgroundColor: 'rgba(42, 143, 189, 0.7)',
          borderColor: 'rgba(42, 143, 189, 1)',
          borderWidth: 1,
          borderRadius: 5,
          hoverBackgroundColor: 'rgba(42, 143, 189, 0.9)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            stepSize: 1,
            ticks: { precision: 0 }
          }
        }
      }
    });

    const ctxPie = document.getElementById('statusPieChart').getContext('2d');
    const openCount = auctions.filter(a => a.status === 'open').length;
    const closedCount = auctions.filter(a => a.status === 'closed').length;

    if (statusPieChartInstance) statusPieChartInstance.destroy();

    statusPieChartInstance = new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: ['Open', 'Closed'],
        datasets: [{
          data: [openCount, closedCount],
          backgroundColor: [
            'rgba(42, 143, 189, 0.7)',
            'rgba(189, 42, 42, 0.7)'
          ],
          borderColor: [
            'rgba(42, 143, 189, 1)',
            'rgba(189, 42, 42, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // Show/hide sections based on role
  function toggleSections() {
    if (!currentUser) {
      bidSection.style.display = 'none';
      newProductSection.style.display = 'none';
      return;
    }
    if (currentUser.role === 'buyer') {
      bidSection.style.display = 'block';
      newProductSection.style.display = 'none';
    } else if (currentUser.role === 'seller') {
      bidSection.style.display = 'none';
      newProductSection.style.display = 'block';
    }
  }

  // Modal functions
  function openWinnerModal(auctionId) {
    currentAuctionForModal = auctions.find(a => a.id === auctionId);
    if (!currentAuctionForModal) return alert('Auction not found');

    modalBidsTableBody.innerHTML = '';

    // Sort bids descending by amount
    const sortedBids = currentAuctionForModal.bids.slice().sort((a,b) => b.amount - a.amount);

    if (sortedBids.length === 0) {
      modalBidsTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No bids to select</td></tr>`;
    } else {
      sortedBids.forEach((bid, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${bid.bidderName}</td>
          <td>GHS ${bid.amount}</td>
          <td><button data-bididx="${idx}">Select</button></td>
        `;
        modalBidsTableBody.appendChild(tr);
      });

      modalBidsTableBody.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const bidIdx = parseInt(btn.getAttribute('data-bididx'));
          selectWinningBid(currentAuctionForModal.id, bidIdx);
        });
      });
    }

    winnerModal.style.display = 'flex';
  }

  function closeWinnerModal() {
    winnerModal.style.display = 'none';
    currentAuctionForModal = null;
  }

  closeModalBtn.addEventListener('click', closeWinnerModal);

  // Pagination buttons events
  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderDashboard();
    }
  });
  nextPageBtn.addEventListener('click', () => {
    const filtered = getFilteredAuctions();
    const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
    if (currentPage < totalPages) {
      currentPage++;
      renderDashboard();
    }
  });

  // Render all dashboard parts
  function renderDashboard() {
    renderUserLists();
    renderAuctions();
    renderCharts();
    toggleSections();
    if (currentUser && currentUser.role === 'buyer') {
      renderAuctionSelect();
    }
  }

  // Initial render
  renderDashboard();

</script>
</body>
</html>
